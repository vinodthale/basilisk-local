name: Basilisk VOF Method - Minimal Compilation CI

on:
  push:
    branches: [ main, fix/vof-method-compile, 'claude/**' ]
    paths:
      - 'vof-method/**'
      - 'ImpactForce-main/**'
      - 'TestImpactForce-main/**'
      - 'src/**'
      - '.github/workflows/ci-compile.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'vof-method/**'
      - 'ImpactForce-main/**'
      - 'TestImpactForce-main/**'
      - 'src/**'
      - '.github/workflows/ci-compile.yml'

jobs:
  compile-vof-method:
    name: Compile minimal Basilisk + VOF + ImpactForce + TestImpactForce
    runs-on: ubuntu-22.04
    timeout-minutes: 60

    env:
      BASILISK_ROOT: ${{ runner.home }}/basilisk
      BASILISK_SRC: ${{ runner.home }}/basilisk/src

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Install system dependencies
      run: |
        sudo apt-get update -y
        sudo apt-get install -y --no-install-recommends \
          gcc g++ make gawk m4 ca-certificates \
          libosmesa6-dev libglu1-mesa-dev libgl1-mesa-dev libglfw3-dev \
          libnetpbm10-dev libpng-dev ffmpeg imagemagick gnuplot curl tar \
          pkg-config

    - name: Cache Basilisk installation
      id: cache-basilisk
      uses: actions/cache@v4
      with:
        # Use a key derived from all files under src to invalidate cache on source changes
        key: ${{ runner.os }}-basilisk-local-${{ hashFiles('src/**') }}
        path: ${{ runner.home }}/basilisk
        restore-keys: |
          ${{ runner.os }}-basilisk-local-

    # Build minimal Basilisk (qcc) if cache miss
    - name: Build minimal Basilisk (qcc)
      if: steps.cache-basilisk.outputs.cache-hit != 'true'
      run: |
        set -euo pipefail
        echo "=== Building minimal Basilisk into $BASILISK_ROOT ==="
        rm -rf "$BASILISK_ROOT"
        mkdir -p "$BASILISK_ROOT"
        if [ -d src ]; then
          cp -r src "$BASILISK_ROOT/"
        else
          echo "No 'src' directory found in repo. Nothing to build for Basilisk." >&2
          exit 1
        fi

        cd "$BASILISK_SRC"
        if [ -f config.gcc ]; then
          ln -sf config.gcc config
        fi

        # Build only the qcc target to avoid GUI/GL targets that require X.
        echo "Running: make -j1 qcc"
        make -j1 qcc

        if [ ! -x "$BASILISK_SRC/qcc" ]; then
          echo "ERROR: qcc was not built or is not executable." >&2
          ls -la "$BASILISK_SRC" || true
          exit 1
        fi
        echo "qcc built successfully at $BASILISK_SRC/qcc"

    - name: Verify Basilisk installation and create safe wrapper
      run: |
        set -euo pipefail
        export BASILISK="$BASILISK_SRC"
        export PATH="$BASILISK:$PATH"
        echo "which qcc -> $(which qcc || echo 'not found')"
        qcc --version 2>/dev/null || echo "qcc exists at: $BASILISK/qcc"

        cat > "$BASILISK_ROOT/qcc-wrapper.sh" <<'EOF'
#!/usr/bin/env bash
set -euo pipefail
B="/home/runner/basilisk/src"
echo "QCC-WRAPPER: $B/qcc $@" 1>&2
exec "$B/qcc" "$@"
EOF
        chmod +x "$BASILISK_ROOT/qcc-wrapper.sh"
        echo "Created qcc-wrapper at $BASILISK_ROOT/qcc-wrapper.sh"

    - name: Export BASILISK env for subsequent steps
      run: |
        echo "BASILISK=$BASILISK_SRC" >> $GITHUB_ENV
        echo "PATH=$BASILISK_SRC:$PATH" >> $GITHUB_ENV

    - name: List VOF method files (if present)
      run: |
        echo "=== vof-method listing ==="
        if [ -d vof-method ]; then
          ls -lah vof-method || true
          ls -1 vof-method/*.c 2>/dev/null || true
          ls -1 vof-method/*.h 2>/dev/null || true
        else
          echo "vof-method directory not present — skipping listing"
        fi

    - name: Run quick VOF test (circle-droplet) OR fallback compile
      run: |
        set -euo pipefail
        export BASILISK=${{ env.BASILISK }}
        export PATH=${{ env.BASILISK }}:$PATH
        if [ -d vof-method ]; then
          cd vof-method
          if [ -x ./ci_run.sh ]; then
            echo "Found vof-method/ci_run.sh -> running quick test 'test'"
            ./ci_run.sh test || { echo "ci_run.sh test failed"; exit 1; }
          else
            echo "Missing ci_run.sh; doing a simple compile of *.c files"
            mkdir -p build
            for f in *.c */*.c; do
              [ -f "$f" ] || continue
              bn=$(basename "$f" .c)
              echo "Compiling $f -> build/$bn"
              "$BASILISK_ROOT/qcc-wrapper.sh" -O2 -Wall -o build/"$bn" "$f"
            done
          fi
        else
          echo "No vof-method directory, skipping VOF step"
        fi

    - name: Compile all VOF simulations (full run - nonfatal)
      run: |
        set -euo pipefail
        export BASILISK=${{ env.BASILISK }}
        export PATH=${{ env.BASILISK }}:$PATH
        if [ -d vof-method ]; then
          cd vof-method
          if [ -x ./ci_run.sh ]; then
            ./ci_run.sh || echo "ci_run.sh returned non-zero (continue to attempt binary collection)"
          else
            echo "No ci_run.sh — skipped full harness"
          fi
        fi

    - name: Verify VOF binaries (non-fatal)
      run: |
        echo "=== VOF binary listing (non-fatal) ==="
        if [ -d vof-method ]; then
          ls -lh vof-method/build/* 2>/dev/null || ls -lh vof-method/* 2>/dev/null || echo "No VOF binaries found"
        else
          echo "No vof-method"
        fi

    - name: Compile ImpactForce-main (if present)
      run: |
        set -euo pipefail
        export BASILISK=${{ env.BASILISK }}
        export PATH=${{ env.BASILISK }}:$PATH
        if [ ! -d ImpactForce-main ]; then
          echo "ImpactForce-main folder not found - skipping."
          exit 0
        fi
        cd ImpactForce-main
        mkdir -p build-impactforce
        find . -maxdepth 3 -type f -name '*.c' | sort | while read -r f; do
          bn=$(basename "$f" .c)
          echo "Compiling $f -> build-impactforce/$bn"
          if ! "$BASILISK_ROOT/qcc-wrapper.sh" -O2 -Wall -o build-impactforce/"$bn" "$f" 2> build-impactforce/"$bn".compile.log; then
            echo "Compilation failed for $f (see build-impactforce/$bn.compile.log)"
          fi
        done
        ls -lah build-impactforce || true

    - name: Compile TestImpactForce-main (if present)
      run: |
        set -euo pipefail
        export BASILISK=${{ env.BASILISK }}
        export PATH=${{ env.BASILISK }}:$PATH
        if [ ! -d TestImpactForce-main ]; then
          echo "TestImpactForce-main folder not found - skipping."
          exit 0
        fi
        cd TestImpactForce-main
        mkdir -p build-testimpact
        find . -maxdepth 2 -type f -name '*.c' | sort | while read -r f; do
          bn=$(basename "$f" .c)
          echo "Compiling $f -> build-testimpact/$bn"
          if ! "$BASILISK_ROOT/qcc-wrapper.sh" -O2 -Wall -o build-testimpact/"$bn" "$f" 2> build-testimpact/"$bn".compile.log; then
            echo "Compilation failed for $f (see build-testimpact/$bn.compile.log)"
          fi
        done
        ls -lah build-testimpact || true

    - name: Collect compiled artifacts and logs
      if: always()
      run: |
        set -euo pipefail
        rm -rf /tmp/ci-artifacts
        mkdir -p /tmp/ci-artifacts

        if [ -d vof-method/build ]; then
          cp -a vof-method/build /tmp/ci-artifacts/vof-method-build || true
        else
          find vof-method -maxdepth 2 -type f -executable -print0 2>/dev/null | xargs -0 -I{} cp {} /tmp/ci-artifacts/ 2>/dev/null || true
        fi

        if [ -d ImpactForce-main/build-impactforce ]; then
          cp -a ImpactForce-main/build-impactforce /tmp/ci-artifacts/ImpactForce-build || true
        fi

        if [ -d TestImpactForce-main/build-testimpact ]; then
          cp -a TestImpactForce-main/build-testimpact /tmp/ci-artifacts/TestImpactForce-build || true
        fi

        find . -type f -name '*.compile.log' -print0 | xargs -0 -I{} cp --parents {} /tmp/ci-artifacts/ || true
        ls -R /tmp/ci-artifacts || true

    - name: Upload compiled binaries & logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: compiled-binaries
        path: /tmp/ci-artifacts
        retention-days: 7

