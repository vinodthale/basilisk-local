name: Basilisk VOF Method - Compilation CI

on:
  push:
    branches: [ main, fix/vof-method-compile, 'claude/**' ]
    paths:
      - 'vof-method/**'
      - 'ImpactForce-main/**'
      - 'TestImpactForce-main/**'
      - 'src/**'
      - '.github/workflows/ci-compile.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'vof-method/**'
      - 'ImpactForce-main/**'
      - 'TestImpactForce-main/**'
      - 'src/**'
      - '.github/workflows/ci-compile.yml'

jobs:
  compile-vof-method:
    name: Compile Basilisk + VOF + ImpactForce + TestImpactForce
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          gcc make gawk m4 \
          libosmesa6-dev libglu1-mesa-dev libgl1-mesa-dev libglfw3-dev \
          libnetpbm10-dev libpng-dev ffmpeg imagemagick gnuplot curl tar

    - name: Cache Basilisk installation
      id: cache-basilisk
      uses: actions/cache@v4
      with:
        path: ~/basilisk
        key: ${{ runner.os }}-basilisk-local-${{ hashFiles('src/**/*.c', 'src/**/*.h', 'src/**/Makefile*') }}
        restore-keys: |
          ${{ runner.os }}-basilisk-local-

    - name: Build Basilisk C from local source
      if: steps.cache-basilisk.outputs.cache-hit != 'true'
      run: |
        echo "Building Basilisk C..."
        mkdir -p ~/basilisk
        cp -r src ~/basilisk/

        cd ~/basilisk/src
        ln -sf config.gcc config

        echo "Building Basilisk compiler and libraries..."
        make -j1 2>&1 | tail -80

        if [ ! -f qcc ]; then
          echo "ERROR: qcc not built"
          exit 1
        fi

        if [ ! -f gl/libglutils.a ] || [ ! -f gl/libfb_tiny.a ]; then
          echo "ERROR: GL libraries not built"
          exit 1
        fi

    - name: Verify Basilisk installation
      run: |
        export BASILISK=$HOME/basilisk/src
        export PATH=$PATH:$BASILISK
        which qcc
        qcc --version
        ls -la $BASILISK/gl/*.a

    - name: List VOF Method Files
      run: |
        echo "=== vof-method contents ==="
        ls -lah vof-method/

    - name: Check tmp_fraction_field.h
      run: |
        if [ ! -f vof-method/tmp_fraction_field.h ]; then
          echo "Missing tmp_fraction_field.h"
          exit 1
        fi

    - name: Quick compile test (circle-droplet)
      run: |
        export BASILISK=$HOME/basilisk/src
        export PATH=$PATH:$BASILISK
        cd vof-method
        ./ci_run.sh test

    - name: Compile all VOF simulations
      run: |
        export BASILISK=$HOME/basilisk/src
        export PATH=$PATH:$BASILISK
        cd vof-method
        ./ci_run.sh

    - name: Verify VOF binaries
      run: |
        echo "=== VOF binaries ==="
        ls -lh vof-method/* || true

    ########################################################
    # NEW BLOCK: IMPACTFORCE-MAIN
    ########################################################

    - name: Compile ImpactForce-main
      run: |
        export BASILISK=$HOME/basilisk/src
        export PATH=$PATH:$BASILISK
        cd ImpactForce-main || exit 0

        echo "=== Building ImpactForce-main ==="
        ls -lah

        for f in *.c */*.c 2>/dev/null; do
          [ -f "$f" ] || continue
          echo "Compiling $f ..."
          qcc -O2 -Wall "$f" -o "$(basename "$f" .c)"
        done

        echo "=== Finished building ImpactForce-main ==="
        ls -lh

    ########################################################
    # NEW BLOCK: TESTIMPACTFORCE-MAIN
    ########################################################

    - name: Compile TestImpactForce-main
      run: |
        export BASILISK=$HOME/basilisk/src
        export PATH=$PATH:$BASILISK
        cd TestImpactForce-main || exit 0

        echo "=== Building TestImpactForce-main ==="
        ls -lah

        for f in *.c */*.c 2>/dev/null; do
          [ -f "$f" ] || continue
          echo "Compiling $f ..."
          qcc -O2 -Wall "$f" -o "$(basename "$f" .c)"
        done

        echo "=== Finished building TestImpactForce-main ==="
        ls -lh

    - name: Verify ImpactForce + TestImpactForce binaries
      run: |
        echo "=== ImpactForce-main binaries ==="
        ls -lh ImpactForce-main/* 2>/dev/null || echo "No binaries"

        echo "=== TestImpactForce-main binaries ==="
        ls -lh TestImpactForce-main/* 2>/dev/null || echo "No binaries"

    ########################################################

    - name: Upload all binaries & logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: compiled-binaries
        path: |
          vof-method/*
          ImpactForce-main/*
          TestImpactForce-main/*
          !**/*.c
          !**/*.h
          !**/*.txt
        retention-days: 7

    - name: Upload fail logs
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: fail-logs
        path: |
          vof-method/*.log
          ImpactForce-main/*.log
          TestImpactForce-main/*.log
