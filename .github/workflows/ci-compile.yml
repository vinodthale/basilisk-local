name: Basilisk VOF + ImpactForce + TestImpactForce CI

on:
  push:
    branches: [ main, fix/vof-method-compile, "claude/**" ]
    paths:
      - "vof-method/**"
      - "ImpactForce-main/**"
      - "TestImpactForce-main/**"
      - "src/**"
      - ".github/workflows/ci-compile.yml"
  pull_request:
    branches: [ main ]
    paths:
      - "vof-method/**"
      - "ImpactForce-main/**"
      - "TestImpactForce-main/**"
      - "src/**"
      - ".github/workflows/ci-compile.yml"

jobs:
  compile:
    name: Compile Basilisk + VOF + ImpactForce + TestImpactForce
    runs-on: ubuntu-22.04

    steps:
    # ----------------------------------------------------------------------
    # Checkout
    # ----------------------------------------------------------------------
    - name: Checkout repository
      uses: actions/checkout@v4

    # ----------------------------------------------------------------------
    # Dependencies
    # ----------------------------------------------------------------------
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          gcc g++ gfortran make gawk m4 \
          libosmesa6-dev libglu1-mesa-dev \
          libgl1-mesa-dev libglfw3-dev \
          libnetpbm10-dev libpng-dev \
          ffmpeg imagemagick gnuplot \
          curl tar

    # ----------------------------------------------------------------------
    # Cache Basilisk
    # ----------------------------------------------------------------------
    - name: Cache Basilisk installation
      id: cache-basilisk
      uses: actions/cache@v4
      with:
        path: ~/basilisk
        key: ${{ runner.os }}-basilisk-local-${{ hashFiles('src/**/*.c', 'src/**/*.h') }}

    # ----------------------------------------------------------------------
    # Build Basilisk
    # ----------------------------------------------------------------------
    - name: Build Basilisk C from local source
      if: steps.cache-basilisk.outputs.cache-hit != 'true'
      run: |
        echo "=== Building Basilisk from src ==="
        mkdir -p ~/basilisk
        cp -r src ~/basilisk/

        cd ~/basilisk/src
        ln -sf config.gcc config

        make -j1 || (echo 'Basilisk build failed' && exit 1)

        if [ ! -f qcc ]; then
          echo "ERROR: qcc not built!"
          exit 1
        fi

        echo "=== Basilisk build complete ==="
        ls -lh qcc gl/*.a

    # ----------------------------------------------------------------------
    # Verify
    # ----------------------------------------------------------------------
    - name: Verify Basilisk installation
      run: |
        export BASILISK=$HOME/basilisk/src
        export PATH=$PATH:$BASILISK
        qcc --version

    # ----------------------------------------------------------------------
    # Helper FUNCTION (safe compiler)
    # ----------------------------------------------------------------------
    - name: Create safe compiler wrapper
      shell: bash
      run: |
        cat << 'EOF' > safe_compile.sh
        #!/usr/bin/env bash
        f="$1"
        # Remove extension
        base=$(basename "$f" .c)
        # Replace / with _
        base=${base//\//_}
        # If starts with digit â†’ prefix
        if [[ "$base" =~ ^[0-9] ]]; then
          base="exe_$base"
        fi
        # Compile
        echo "[CC] $f --> $base"
        qcc -O2 -Wall "$f" -o "$base"
        EOF
        chmod +x safe_compile.sh

    # ----------------------------------------------------------------------
    # VOF-METHOD COMPILATION
    # ----------------------------------------------------------------------
    - name: Build VOF method
      run: |
        export BASILISK=$HOME/basilisk/src
        export PATH=$PATH:$BASILISK

        cd vof-method

        if [ ! -f ci_run.sh ]; then
          echo "ERROR: missing ci_run.sh in vof-method/"
          exit 1
        fi

        echo "=== Running VOF quick test ==="
        ./ci_run.sh test

        echo "=== Compiling all VOF simulations ==="
        ./ci_run.sh

        echo "=== VOF binaries ==="
        ls -lh || true

    # ----------------------------------------------------------------------
    # IMPACTFORCE-MAIN COMPILATION
    # ----------------------------------------------------------------------
    - name: Compile ImpactForce-main
      run: |
        export BASILISK=$HOME/basilisk/src
        export PATH=$PATH:$BASILISK

        cd ImpactForce-main || exit 0
        echo "=== Files in ImpactForce-main ==="
        ls -lah

        find . -type f -name "*.c" | while read -r f; do
          ../safe_compile.sh "$f"
        done

        echo "=== ImpactForce binaries ==="
        ls -lh || true

    # ----------------------------------------------------------------------
    # TESTIMPACTFORCE-MAIN COMPILATION
    # ----------------------------------------------------------------------
    - name: Compile TestImpactForce-main
      run: |
        export BASILISK=$HOME/basilisk/src
        export PATH=$PATH:$BASILISK

        cd TestImpactForce-main || exit 0
        echo "=== Files in TestImpactForce-main ==="
        ls -lah

        find . -type f -name "*.c" | while read -r f; do
          ../safe_compile.sh "$f"
        done

        echo "=== TestImpactForce binaries ==="
        ls -lh || true

    # ----------------------------------------------------------------------
    # UPLOAD RESULTS
    # ----------------------------------------------------------------------
    - name: Upload all binaries & logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: compiled-binaries
        path: |
          vof-method/*
          ImpactForce-main/*
          TestImpactForce-main/*
          !**/*.c
          !**/*.h
          !**/*.txt
        retention-days: 7
