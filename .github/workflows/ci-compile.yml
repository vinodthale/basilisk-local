name: Basilisk VOF Method - Minimal Compilation CI

on:
  push:
    branches: [ main, fix/vof-method-compile, 'claude/**' ]
    paths:
      - 'vof-method/**'
      - 'ImpactForce-main/**'
      - 'TestImpactForce-main/**'
      - 'src/**'
      - '.github/workflows/ci-compile.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'vof-method/**'
      - 'ImpactForce-main/**'
      - 'TestImpactForce-main/**'
      - 'src/**'
      - '.github/workflows/ci-compile.yml'

jobs:
  compile-vof-method:
    name: Compile minimal Basilisk + VOF + ImpactForce + TestImpactForce
    runs-on: ubuntu-22.04
    timeout-minutes: 60

    env:
      BASILISK_ROOT: $HOME/basilisk
      BASILISK_SRC: $HOME/basilisk/src

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Install system dependencies
      run: |
        sudo apt-get update -y
        sudo apt-get install -y --no-install-recommends \
          gcc g++ make gawk m4 ca-certificates \
          libosmesa6-dev libglu1-mesa-dev libgl1-mesa-dev libglfw3-dev \
          libnetpbm10-dev libpng-dev ffmpeg imagemagick gnuplot curl tar \
          pkg-config

    - name: Cache Basilisk installation
      id: cache-basilisk
      uses: actions/cache@v4
      with:
        key: ${{ runner.os }}-basilisk-local-${{ hashFiles('src/**') }}
        path: $HOME/basilisk
        restore-keys: |
          ${{ runner.os }}-basilisk-local-

    - name: Build minimal Basilisk (qcc)
      if: steps.cache-basilisk.outputs.cache-hit != 'true'
      run: |
        set -euo pipefail
        rm -rf "$BASILISK_ROOT"
        mkdir -p "$BASILISK_ROOT"
        cp -r src "$BASILISK_ROOT/"
        cd "$BASILISK_SRC"
        ln -sf config.gcc config
        make -j1 qcc
        if [ ! -x qcc ]; then
          echo "ERROR: qcc not built"
          exit 1
        fi

    - name: Verify Basilisk installation and create safe wrapper
      run: |
        set -euo pipefail
        export BASILISK="$BASILISK_SRC"
        export PATH="$BASILISK:$PATH"

        cat > "$BASILISK_ROOT/qcc-wrapper.sh" <<'EOF'
#!/usr/bin/env bash
set -euo pipefail
BASILISK_BIN="${BASILISK:-$HOME/basilisk/src}"
exec "$BASILISK_BIN/qcc" "$@"
EOF
        chmod +x "$BASILISK_ROOT/qcc-wrapper.sh"

        echo "BASILISK=$BASILISK_SRC" >> $GITHUB_ENV
        echo "BASILISK_ROOT=$BASILISK_ROOT" >> $GITHUB_ENV
        echo "BASILISK_SRC=$BASILISK_SRC" >> $GITHUB_ENV
        echo "PATH=$BASILISK_SRC:$PATH" >> $GITHUB_ENV

    - name: List VOF method files (if present)
      run: |
        if [ -d vof-method ]; then
          ls -lah vof-method
        fi

    - name: Run quick VOF test
      run: |
        if [ -d vof-method ]; then
          cd vof-method
          if [ -x ./ci_run.sh ]; then
            ./ci_run.sh test
          else
            mkdir -p build
            for f in *.c; do
              bn=$(basename "$f" .c)
              "$BASILISK_ROOT/qcc-wrapper.sh" -O2 -Wall -o build/"$bn" "$f"
            done
          fi
        fi

    - name: Compile all VOF simulations
      continue-on-error: true
      run: |
        if [ -d vof-method ] && [ -x vof-method/ci_run.sh ]; then
          cd vof-method
          ./ci_run.sh || true
        fi

    - name: Verify VOF binaries
      continue-on-error: true
      run: |
        ls -lh vof-method/build/* 2>/dev/null || ls -lh vof-method/* 2>/dev/null || true

    - name: Compile ImpactForce-main
      continue-on-error: true
      run: |
        if [ -d ImpactForce-main ]; then
          cd ImpactForce-main
          mkdir -p build-impactforce
          find . -maxdepth 3 -type f -name '*.c' -print0 | while IFS= read -r -d '' f; do
            bn=$(basename "$f" .c)
            "$BASILISK_ROOT/qcc-wrapper.sh" -O2 -Wall -o build-impactforce/"$bn" "$f" \
              2> build-impactforce/"$bn".compile.log || true
          done
        fi

    - name: Compile TestImpactForce-main
      continue-on-error: true
      run: |
        if [ -d TestImpactForce-main ]; then
          cd TestImpactForce-main
          mkdir -p build-testimpact
          find . -maxdepth 2 -type f -name '*.c' -print0 | while IFS= read -r -d '' f; do
            bn=$(basename "$f" .c)
            "$BASILISK_ROOT/qcc-wrapper.sh" -O2 -Wall -o build-testimpact/"$bn" "$f" \
              2> build-testimpact/"$bn".compile.log || true
          done
        fi

    - name: Collect compiled artifacts and logs
      if: always()
      run: |
        rm -rf /tmp/ci-artifacts
        mkdir -p /tmp/ci-artifacts
        cp -a vof-method/build /tmp/ci-artifacts/vof-method 2>/dev/null || true
        cp -a ImpactForce-main/build-impactforce /tmp/ci-artifacts/impactforce 2>/dev/null || true
        cp -a TestImpactForce-main/build-testimpact /tmp/ci-artifacts/testimpact 2>/dev/null || true
        find . -type f -name '*.compile.log' -exec cp {} /tmp/ci-artifacts/ \;

    - name: Upload compiled binaries & logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: compiled-binaries
        path: /tmp/ci-artifacts
        retention-days: 7


